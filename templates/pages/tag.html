{% extends "base.html" %}
{% block meta_data %}
{% set base_url = SITE_URL or 'https://nationalbusiness.kz' %}

{% if tag.seo_title %}
<title>{{ tag.seo_title }}</title>
{% else %}
<title>Тег новостей | nationalbusiness.kz - {{ tag.title }}</title>
{% endif %}

<link rel="canonical" href="{{ base_url }}/tag/{{ tag.slug }}/"/>
<meta name="description"
      content="{{ (tag.description|striptags|e) or ('Материалы тега ' ~ tag.title ~ ' на nationalbusiness.kz') }}"/>
<meta name="keywords" content="теги {{ tag.title|striptags|e }}"/>
<meta name="author" content="Редакция nationalbusiness.kz"/>

{# — JSON-LD: CollectionPage для списка статей по тегу — #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "{{ tag.title }}",
  "description": "{{ (tag.description|striptags|e or ('Материалы тега ' ~ tag.title ~ ' на nationalbusiness.kz')) }}",
  "url": "{{ base_url }}/tag/{{ tag.slug }}/",
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": [
      {% for article in page.items %}
      {
        "@type": "ListItem",
        "position": {{ loop.index }},
        "url": "{{ base_url }}/news/{{ article.alias }}/",
        "name": "{{ article.title|striptags|e }}"
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Главная",
      "item": "{{ base_url }}/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ tag.title|e }}",
      "item": "{{ base_url }}/tag/{{ tag.slug }}/"
    }
  ]
}
</script>

{% endblock meta_data %}

{% block content %}
  {% include 'header.html' %}

  <main class="default-layout desktop-margin-wide subcategory-page">
    <div class="content">
      <h1 class="subcategory-page-title">Тег: {{ tag.title or tag.slug }}</h1>

      {% set items = page.items | default([], true) %}

      {% if items and items|length > 0 %}
        <div class="subcategory-page-news-list" role="list">
          {% for art in items %}
            {% with
              image_webp_800 = art.image.image_webp_800 | default(art.image.image_800_webp, true) | default('/static/img/plug.jpg', true),
              image_jpeg_800 = art.image.image_jpeg_800 | default(art.image.image_800_jpeg, true) | default('/static/img/plug.jpg', true)
            %}
            <article class="article-related__card" role="listitem">
              <figure class="article-related__figure">
                <picture>
                  <source media="(max-width: 699px)" type="image/webp" data-srcset="{{ image_webp_800 }}">
                  <img
                    class="lazy"
                    data-src="{{ image_jpeg_800 }}"
                    alt="{{ art.image.alt or art.title }}"
                  />
                </picture>
              </figure>
              <h4 class="article-related__card-title">
                <a href="{{ SITE_URL }}/news/{{ art.alias }}/">{{ art.title }}</a>
              </h4>
            </article>
            {% endwith %}
          {% endfor %}
        </div>
      {% else %}
        <p style="margin:24px 0">Материалов с этим тегом пока нет.</p>
      {% endif %}

      {% if page.pages > 1 %}
        {% include 'pagination.html' %}
      {% endif %}
    </div>
  </main>

  {% include 'footer.html' %}
{% endblock content %}

{% block scripts %}
  <script type="module" crossorigin src="/static/scripts/main.js"></script>
{% endblock scripts %}